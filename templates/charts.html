<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Analytics Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --bg: #f7f7fb;
      --card: #fff;
      --border: #ececf2;
      --text: #111827;
      --muted: #6b7280;
      --shadow: 0 4px 16px rgba(0,0,0,.06);
      --radius: 16px;
      --pad: 20px;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      padding: 32px;
      font: 16px/1.5 system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      color: var(--text);
      background: var(--bg);
    }
    h1 {
      font-size: 44px;
      margin: 0 0 24px;
      letter-spacing: .2px;
    }
    .grid {
      display: grid;
      gap: 20px;
      grid-template-columns: 1fr 1fr;
    }
    @media (max-width: 980px) {
      .grid { grid-template-columns: 1fr; }
    }
    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: var(--pad);
    }
    .card h3 {
      margin: 0 0 12px;
      font-size: 22px;
    }
    .canvas-wrap {
      position: relative;
      width: 100%;
      height: 420px;
    }
    .legend-top {
      margin-bottom: 8px;
      color: var(--muted);
      font-size: 14px;
    }
  </style>
</head>
<body>
  <h1>Analytics</h1>

  <div class="grid">
    <!-- Employees per Department (Pie) -->
    <section class="card">
      <h3>Employees per Department</h3>
      <div class="legend-top" id="deptLegend"></div>
      <div class="canvas-wrap">
        <canvas id="deptChart"></canvas>
      </div>
    </section>

    <!-- Monthly Attendance (Bar) -->
    <section class="card">
      <h3>Monthly Attendance (Present count)</h3>
      <div class="legend-top" id="attLegend"></div>
      <div class="canvas-wrap">
        <canvas id="attChart"></canvas>
      </div>
    </section>
  </div>

  <script>
    const palette = [
      '#4F46E5', '#EF4444', '#F59E0B', '#10B981',
      '#06B6D4', '#8B5CF6', '#9CA3AF'
    ];

    const el = (id) => document.getElementById(id);

    // ✅ Employees per Department (Pie)
    fetch("/api/v1/analytics/employees-per-department/")
      .then(r => {
        if (!r.ok) throw new Error("HTTP " + r.status);
        return r.json();
      })
      .then(({ labels, values }) => {
        const ctx = el("deptChart").getContext("2d");
        new Chart(ctx, {
          type: "pie",
          data: {
            labels,
            datasets: [{
              data: values,
              backgroundColor: labels.map((_, i) => palette[i % palette.length]),
              borderColor: "#ffffff",
              borderWidth: 2
            }]
          },
          options: {
            responsive: true,
            plugins: {
              legend: { display: false },
              tooltip: { enabled: true }
            }
          }
        });

        el("deptLegend").innerHTML = labels.map((label, i) => {
          const color = palette[i % palette.length];
          return `<span style="display:inline-flex;align-items:center;margin-right:12px;margin-bottom:6px">
                    <span style="width:12px;height:12px;border-radius:3px;background:${color};display:inline-block;margin-right:6px"></span>
                    ${label}
                  </span>`;
        }).join("");
      })
      .catch(err => console.error("Dept chart error:", err));

    // ✅ Monthly Attendance (Bar)
    fetch("/api/v1/analytics/monthly-attendance/")
      .then(r => {
        if (!r.ok) throw new Error("HTTP " + r.status);
        return r.json();
      })
      .then(({ labels, values }) => {
        const ctx = el("attChart").getContext("2d");
        new Chart(ctx, {
          type: "bar",
          data: {
            labels,
            datasets: [{
              label: "Present",
              data: values,
              backgroundColor: "rgba(59,130,246,.35)",
              borderColor: "rgba(59,130,246,1)",
              borderWidth: 1,
              borderRadius: 8,
            }]
          },
          options: {
            responsive: true,
            scales: {
              y: { beginAtZero: true, ticks: { precision: 0 } }
            },
            plugins: {
              legend: { position: "top" },
              tooltip: { enabled: true }
            }
          }
        });
        el("attLegend").textContent = "Present";
      })
      .catch(err => console.error("Attendance chart error:", err));
  </script>
</body>
</html>
